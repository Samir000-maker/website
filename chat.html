<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chat Room - MoodLog</title>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200..800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="global.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Manrope', sans-serif;
        }
        
        /* Message animations */
        .reply-btn {
            opacity: 0;
            transition: opacity 0.2s ease;
            cursor: pointer;
        }
        .message-item:hover .reply-btn {
            opacity: 1;
        }
        
        .reply-preview {
            animation: slideUp 0.2s ease-out;
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(10px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .quoted-message {
            border-left: 3px solid #93c5fd;
            padding-left: 8px;
            margin-bottom: 6px;
            background-color: rgba(255, 255, 255, 0.15);
            padding: 6px 8px;
            border-radius: 6px;
            font-size: 0.813rem;
        }
        
        .quoted-message-light {
            background-color: rgba(0, 0, 0, 0.05);
            border-left-color: #4a9d9d;
        }

        /* Responsive sidebar */
        .sidebar {
            transition: transform 0.3s ease;
        }
        
        
        /* Fix for mobile navigation bars */
.main-container {
    height: 100vh;
    height: 100dvh; /* Dynamic viewport height - excludes nav bars */
}

.chat-main {
    max-height: calc(100vh - 64px); /* 64px for header */
    max-height: calc(100dvh - 64px);
}

@media (max-width: 768px) {
    .chat-main {
        max-height: calc(100vh - 56px); /* 56px for mobile header */
        max-height: calc(100dvh - 56px);
    }
}
        
        /* Mobile: sidebar overlay */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                height: 100vh;
                width: 280px;
                z-index: 40;
                box-shadow: 2px 0 10px rgba(0,0,0,0.1);
                transform: translateX(-100%);
            }
            
            .sidebar.show {
                transform: translateX(0);
            }
            
            .sidebar-overlay {
                position: fixed;
                inset: 0;
                background: rgba(0,0,0,0.5);
                z-index: 30;
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.3s ease;
            }
            
            .sidebar-overlay.active {
                opacity: 1;
                pointer-events: auto;
            }
        }
        
        /* Desktop: sidebar always visible */
        @media (min-width: 769px) {
            .sidebar {
                position: relative;
                width: 280px;
                min-width: 280px;
                display: block !important;
            }
            
            .sidebar-toggle {
                display: none;
            }
            
            .sidebar-overlay {
                display: none;
            }
        }

        .user-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .user-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .calling {
            opacity: 0.6;
            cursor: not-allowed;
            pointer-events: none;
        }
        
        /* Call buttons positioning */
        .call-buttons-container {
            position: relative;
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        @media (max-width: 640px) {
            .call-buttons-container {
                gap: 8px;
            }
        }
        
        /* Safe area for notched devices */
        @supports (padding: max(0px)) {
            .header-safe {
                padding-top: max(1rem, env(safe-area-inset-top));
            }
            
            .bottom-safe {
                padding-bottom: max(1rem, env(safe-area-inset-bottom));
            }
        }
        
        /* Input area responsive */
        @media (max-width: 640px) {
            #messageForm {
                gap: 8px;
            }
            
            #messageInput {
                font-size: 16px; /* Prevents zoom on iOS */
                min-height: 44px; /* Touch target size */
            }
            
            #messageForm button[type="submit"] {
                min-width: 44px;
                min-height: 44px;
            }
        }
    </style>
</head>
<body class="bg-background-light main-container flex flex-col overflow-hidden">
    <!-- Header with mobile menu toggle -->
    <header class="sticky top-0 z-50 w-full border-b border-gray-200 bg-white/95 backdrop-blur header-safe">
        <div class="mx-auto flex h-14 sm:h-16 max-w-full items-center justify-between px-3 sm:px-6">
            <div class="flex items-center gap-2 sm:gap-3 flex-1 min-w-0">
                <!-- Mobile menu toggle -->
                <button id="sidebarToggle" class="sidebar-toggle p-2 hover:bg-gray-100 rounded-lg md:hidden flex-shrink-0">
                    <span class="material-symbols-outlined text-gray-700">menu</span>
                </button>
                
                <div class="min-w-0 flex-1">
                    <h2 class="text-base sm:text-lg font-bold truncate">Mindful Space</h2>
                    <div class="flex items-center gap-1.5 sm:gap-2 text-xs text-gray-500">
                        <span class="flex h-2 w-2 rounded-full bg-green-500 flex-shrink-0"></span>
                        <span id="onlineCount" class="truncate">Loading...</span>
                        <span class="hidden sm:inline">â€¢</span>
                        <span id="timeRemaining" class="hidden sm:inline truncate">--:-- remaining</span>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center gap-2 sm:gap-3 flex-shrink-0">
                <!-- Call buttons integrated in header -->
                <div class="call-buttons-container">
                    <button id="audioCallBtn" 
                        class="w-9 h-9 sm:w-10 sm:h-10 flex items-center justify-center rounded-full bg-primary text-white hover:bg-primary/90 transition-all"
                        title="Start Audio Call">
                        <span class="material-symbols-outlined text-lg sm:text-xl">call</span>
                    </button>
                    <button id="videoCallBtn" 
                        class="w-9 h-9 sm:w-10 sm:h-10 flex items-center justify-center rounded-full bg-primary text-white hover:bg-primary/90 transition-all"
                        title="Start Video Call">
                        <span class="material-symbols-outlined text-lg sm:text-xl">videocam</span>
                    </button>
                </div>
                
                <button id="leaveBtn" class="text-xs sm:text-sm font-medium text-red-600 hover:text-red-700 px-2 sm:px-3 py-1.5 sm:py-2 whitespace-nowrap">
                    <span class="hidden sm:inline">Leave Room</span>
                    <span class="sm:hidden material-symbols-outlined text-xl">logout</span>
                </button>
            </div>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden relative chat-main">
        <!-- Sidebar overlay (mobile only) -->
        <div id="sidebarOverlay" class="sidebar-overlay"></div>
        
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar border-r border-gray-200 bg-white overflow-y-auto">
            <div class="p-3 sm:p-4">
                <div class="flex items-center justify-between mb-3 sm:mb-4">
                    <h3 class="text-xs font-bold text-gray-500 uppercase">Active Users</h3>
                    <!-- Close button (mobile only) -->
                    <button id="sidebarClose" class="md:hidden p-1 hover:bg-gray-100 rounded">
                        <span class="material-symbols-outlined text-gray-500 text-xl">close</span>
                    </button>
                </div>
                <div id="usersList" class="space-y-2 sm:space-y-3"></div>
            </div>
        </aside>

<!-- Main chat area -->
<main class="flex-1 flex flex-col min-h-0 bg-white">
    <!-- Messages list -->
    <div id="messagesList" class="flex-1 overflow-y-auto px-2 sm:px-4 py-3 sm:py-6 space-y-2 sm:space-y-4 min-h-0">
        <div class="text-center text-xs sm:text-sm text-gray-400 mb-4">
            Welcome to the safe space. Be kind and supportive.
        </div>
    </div>

    <!-- Input area - MOBILE SAFE -->
<div class="border-t border-gray-200 bg-white flex-shrink-0 sticky bottom-0 left-0 right-0 z-10" style="padding-bottom: env(safe-area-inset-bottom, 0px);">
    <!-- Reply preview -->
    <div id="replyPreview" class="reply-preview hidden border-b border-gray-200 px-3 py-2 bg-gray-50">
        <div class="flex items-start justify-between gap-2">
            <div class="flex-1 min-w-0">
                <div class="flex items-center gap-1.5 mb-1">
                    <span class="material-symbols-outlined text-primary text-sm">subdirectory_arrow_left</span>
                    <span class="text-xs font-medium text-primary" id="replyToUsername">Replying to User</span>
                </div>
                <p class="text-xs text-gray-600 truncate" id="replyToMessage">Original message text</p>
            </div>
            <button id="cancelReply" class="text-gray-400 hover:text-gray-600 p-1">
                <span class="material-symbols-outlined text-lg">close</span>
            </button>
        </div>
    </div>
    
    <!-- Message form -->
    <div class="p-3 pb-4">
        <form id="messageForm" class="flex gap-2 items-center">
            <input type="text" id="messageInput" required maxlength="500"
                class="flex-1 px-4 py-3 text-base border-2 border-gray-300 rounded-xl focus:border-primary focus:outline-none bg-white"
                placeholder="Type a message..." style="min-width: 0; -webkit-appearance: none;">
            <button type="submit" class="w-12 h-12 flex-shrink-0 flex items-center justify-center bg-primary text-white rounded-xl hover:bg-primary/90 active:scale-95 transition-transform">
                <span class="material-symbols-outlined">send</span>
            </button>
        </form>
    </div>
</div>
</main>
    </div>

    <!-- Incoming call modal (responsive) -->
    <div id="incomingCallModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-6 sm:p-8 max-w-sm w-full animate-fade-in">
            <div class="text-center">
                <div class="mb-4 sm:mb-6">
                    <div id="callerAvatar" class="w-20 h-20 sm:w-24 sm:h-24 mx-auto rounded-full overflow-hidden bg-primary/20 flex items-center justify-center">
                        <span class="text-3xl sm:text-4xl">ðŸ“ž</span>
                    </div>
                </div>
                <h3 class="text-lg sm:text-xl font-bold mb-2" id="callerName">Incoming Call</h3>
                <p class="text-sm sm:text-base text-gray-600 mb-6 sm:mb-8" id="callType">Audio Call</p>
                
                <div class="flex gap-3 sm:gap-4 justify-center">
                    <button id="declineCallBtn" 
                        class="flex items-center gap-2 px-5 sm:px-6 py-2.5 sm:py-3 rounded-xl bg-red-500 text-white hover:bg-red-600 transition-all text-sm sm:text-base">
                        <span class="material-symbols-outlined text-lg sm:text-xl">call_end</span>
                        <span class="font-medium">Decline</span>
                    </button>
                    <button id="acceptCallBtn" 
                        class="flex items-center gap-2 px-5 sm:px-6 py-2.5 sm:py-3 rounded-xl bg-green-500 text-white hover:bg-green-600 transition-all text-sm sm:text-base">
                        <span class="material-symbols-outlined text-lg sm:text-xl">call</span>
                        <span class="font-medium">Accept</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyA0aEEUk7uPGk2vK69HjhW7Ug0GCWOksLU",
        authDomain: "projectt3-8c55e.firebaseapp.com",
        projectId: "projectt3-8c55e",
        storageBucket: "projectt3-8c55e.firebasestorage.app",
        messagingSenderId: "64611387728",
        appId: "1:64611387728:web:2e53a18151ab3de1b60455",
        measurementId: "G-0Z91D0Q6EE"
      };

      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
      firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL);
    </script>

    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <script src="app.js"></script>

    <script>
    (async () => {
      const MoodApp = window.MoodApp || {};
      const _Auth = MoodApp.Auth;
      const _API = MoodApp.API;
      const _Toast = MoodApp.Toast;
      const _Utils = MoodApp.Utils;

      const toast = (m, t='success') => { 
        if (_Toast && typeof _Toast[t] === 'function') return _Toast[t](m); 
        console[t==='error'?'error':'log'](m); 
      };

      let replyingTo = null;
      let isInitiatingCall = false;
      let pendingCallData = null;
      let navigatingToCall = false;

// Mobile sidebar toggle - IMPROVED
const sidebar = document.getElementById('sidebar');
const sidebarToggle = document.getElementById('sidebarToggle');
const sidebarClose = document.getElementById('sidebarClose');
const sidebarOverlay = document.getElementById('sidebarOverlay');

function openSidebar() {
  sidebar.classList.add('show');
  sidebarOverlay.classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closeSidebar() {
  sidebar.classList.remove('show');
  sidebarOverlay.classList.remove('active');
  document.body.style.overflow = '';
}

function toggleSidebar() {
  if (sidebar.classList.contains('show')) {
    closeSidebar();
  } else {
    openSidebar();
  }
}

if (sidebarToggle) {
  sidebarToggle.addEventListener('click', toggleSidebar); // Changed to toggleSidebar
}

if (sidebarClose) {
  sidebarClose.addEventListener('click', closeSidebar);
}

if (sidebarOverlay) {
  sidebarOverlay.addEventListener('click', closeSidebar);
}

// Close sidebar when clicking a user (mobile)
function setupUserCardClick() {
  if (window.innerWidth <= 768) {
    document.querySelectorAll('.user-card').forEach(card => {
      card.addEventListener('click', closeSidebar);
    });
  }
}

      function createProfilePictureElement(pfpUrl, username, size = 'w-10 h-10') {
        const initial = username ? username.charAt(0).toUpperCase() : 'U';
        const container = document.createElement('div');
        container.className = `${size} rounded-full overflow-hidden bg-slate-100 border-2 border-white shadow-sm flex-shrink-0`;
        
        if (pfpUrl && pfpUrl !== 'https://ui-avatars.com/api/?name=User&background=367d7d&color=ffffff&size=200') {
          const img = document.createElement('img');
          img.src = pfpUrl;
          img.alt = username;
          img.className = 'h-full w-full object-cover';
          img.onerror = function() {
            this.onerror = null;
            container.innerHTML = `<div class="h-full w-full bg-primary text-white flex items-center justify-center font-bold text-sm">${initial}</div>`;
          };
          container.appendChild(img);
        } else {
          container.innerHTML = `<div class="h-full w-full bg-primary text-white flex items-center justify-center font-bold text-sm">${initial}</div>`;
        }
        
        return container;
      }

      function showReplyPreview(messageData) {
        replyingTo = messageData;
        const replyPreview = document.getElementById('replyPreview');
        const replyToUsername = document.getElementById('replyToUsername');
        const replyToMessage = document.getElementById('replyToMessage');
        const messageInput = document.getElementById('messageInput');
        
        if (replyPreview && replyToUsername && replyToMessage) {
          replyToUsername.textContent = `Replying to ${messageData.username}`;
          replyToMessage.textContent = messageData.message;
          replyPreview.classList.remove('hidden');
          
          if (messageInput) {
            messageInput.focus();
          }
        }
      }

      function hideReplyPreview() {
        replyingTo = null;
        const replyPreview = document.getElementById('replyPreview');
        if (replyPreview) {
          replyPreview.classList.add('hidden');
        }
      }

      function escapeHtml(text) {
        if (_Utils && typeof _Utils.escapeHtml === 'function') {
          return _Utils.escapeHtml(text);
        }
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      function formatTimestamp(timestamp) {
        if (_Utils && typeof _Utils.formatDate === 'function') {
          return _Utils.formatDate(timestamp);
        }
        return new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      }

      function createMessageElement(data, isCurrentUser) {
        const messageItem = document.createElement('div');
        messageItem.className = `message-item flex gap-2 items-start ${isCurrentUser ? 'flex-row-reverse' : ''} animate-fade-in-up`;
        messageItem.dataset.messageId = data.messageId || `msg-${Date.now()}-${Math.random()}`;
        
        const pfpContainer = createProfilePictureElement(data.pfpUrl, data.username, 'w-8 h-8 sm:w-10 sm:h-10');
        const messageContent = document.createElement('div');
        messageContent.className = `flex flex-col ${isCurrentUser ? 'items-end' : 'items-start'} max-w-[75%] sm:max-w-[70%] flex-1 min-w-0`;

        const headerDiv = document.createElement('div');
        headerDiv.className = `flex items-center gap-1.5 sm:gap-2 mb-1 px-1 ${isCurrentUser ? 'flex-row-reverse' : ''}`;
        
        const usernameSpan = document.createElement('span');
        usernameSpan.className = 'text-xs sm:text-sm font-semibold text-gray-900 truncate';
        usernameSpan.textContent = data.username || 'User';
        
        const timestampSpan = document.createElement('span');
        timestampSpan.className = 'text-[10px] sm:text-xs text-gray-400 whitespace-nowrap';
        timestampSpan.textContent = data.timestamp ? formatTimestamp(data.timestamp) : 'Just now';
        
        headerDiv.appendChild(usernameSpan);
        headerDiv.appendChild(timestampSpan);
        messageContent.appendChild(headerDiv);

        const bubbleWrapper = document.createElement('div');
        bubbleWrapper.className = 'flex items-center gap-1';
        if (isCurrentUser) {
          bubbleWrapper.className += ' flex-row-reverse';
        }

        const messageBubble = document.createElement('div');
        messageBubble.className = `px-3 sm:px-4 py-2 rounded-2xl ${isCurrentUser ? 'bg-primary text-white' : 'bg-gray-100 text-gray-900'} break-words text-sm sm:text-base max-w-full`;

        if (data.replyTo) {
          const quotedDiv = document.createElement('div');
          quotedDiv.className = `quoted-message ${isCurrentUser ? '' : 'quoted-message-light'}`;
          
          const quotedUsername = document.createElement('div');
          quotedUsername.className = `text-xs font-semibold mb-1 ${isCurrentUser ? 'text-blue-200' : 'text-primary'}`;
          quotedUsername.textContent = data.replyTo.username;
          
          const quotedText = document.createElement('div');
          quotedText.className = `text-xs ${isCurrentUser ? 'text-white/80' : 'text-gray-600'} break-words`;
          quotedText.textContent = data.replyTo.message;
          
          quotedDiv.appendChild(quotedUsername);
          quotedDiv.appendChild(quotedText);
          messageBubble.appendChild(quotedDiv);
        }

        const messageText = document.createElement('div');
        messageText.className = 'text-sm sm:text-base break-words';
        messageText.innerHTML = escapeHtml(data.message || '');
        messageBubble.appendChild(messageText);

        const replyBtn = document.createElement('button');
        replyBtn.className = 'reply-btn p-1 sm:p-1.5 hover:bg-gray-100 rounded-full transition-colors flex-shrink-0';
        replyBtn.title = 'Reply';
        replyBtn.innerHTML = '<span class="material-symbols-outlined text-gray-400 text-base sm:text-lg">reply</span>';
        replyBtn.addEventListener('click', () => {
          showReplyPreview({
            messageId: messageItem.dataset.messageId,
            username: data.username,
            message: data.message,
            userId: data.userId
          });
        });

        if (isCurrentUser) {
          bubbleWrapper.appendChild(replyBtn);
          bubbleWrapper.appendChild(messageBubble);
        } else {
          bubbleWrapper.appendChild(messageBubble);
          bubbleWrapper.appendChild(replyBtn);
        }

        messageContent.appendChild(bubbleWrapper);
        messageItem.appendChild(pfpContainer);
        messageItem.appendChild(messageContent);
        
        return messageItem;
      }

      try {
        await _Auth.requireAuth();
      } catch (err) {
        console.error('Auth required failed:', err);
        window.location.href = '/login.html';
        return;
      }

      const roomDataStr = localStorage.getItem('currentRoom');
      if (!roomDataStr) {
        toast('No active room found', 'error');
        setTimeout(() => window.location.href = '/mood.html', 1500);
        return;
      }

      const roomData = JSON.parse(roomDataStr);
      if (!roomData.roomId) {
        toast('Invalid room data', 'error');
        setTimeout(() => window.location.href = '/mood.html', 1500);
        return;
      }

      const firebaseUser = firebase.auth().currentUser;
      if (!firebaseUser) {
        window.location.href = '/login.html';
        return;
      }

      const userData = await _API.get('/api/users/me');
      const currentUser = {
        userId: userData._id,
        username: userData.username,
        pfpUrl: userData.pfpUrl
      };

      const messagesList = document.getElementById('messagesList');
      const messageForm = document.getElementById('messageForm');
      const messageInput = document.getElementById('messageInput');
      const usersList = document.getElementById('usersList');
      const onlineCount = document.getElementById('onlineCount');
      const timeRemaining = document.getElementById('timeRemaining');
      const leaveBtn = document.getElementById('leaveBtn');
      const cancelReplyBtn = document.getElementById('cancelReply');
      const audioCallBtn = document.getElementById('audioCallBtn');
      const videoCallBtn = document.getElementById('videoCallBtn');
      const incomingCallModal = document.getElementById('incomingCallModal');
      const acceptCallBtn = document.getElementById('acceptCallBtn');
      const declineCallBtn = document.getElementById('declineCallBtn');

      if (cancelReplyBtn) {
        cancelReplyBtn.addEventListener('click', hideReplyPreview);
      }

      if (usersList && Array.isArray(roomData.users)) {
        roomData.users.forEach(user => {
          const userCard = document.createElement('div');
          userCard.className = 'user-card flex items-center gap-2 sm:gap-3 p-2 sm:p-3 rounded-lg hover:bg-gray-50 transition-all cursor-pointer';
          
          const pfpElement = createProfilePictureElement(user.pfpUrl, user.username, 'w-10 h-10 sm:w-12 sm:h-12');
          
          const userInfo = document.createElement('div');
          userInfo.className = 'flex-1 min-w-0';
          
          const nameSpan = document.createElement('div');
          nameSpan.className = 'text-sm font-semibold truncate';
          nameSpan.textContent = user.username || 'User';
          
          const statusSpan = document.createElement('div');
          statusSpan.className = 'text-xs text-gray-500 flex items-center gap-1';
          statusSpan.innerHTML = '<span class="flex h-2 w-2 rounded-full bg-green-500 flex-shrink-0"></span> Online';
          
          userInfo.appendChild(nameSpan);
          userInfo.appendChild(statusSpan);
          
          userCard.appendChild(pfpElement);
          userCard.appendChild(userInfo);
          usersList.appendChild(userCard);
        });

        setupUserCardClick();

        if (onlineCount) {
          onlineCount.textContent = `${roomData.users.length} Online`;
        }
      }

      let timerInterval = null;
      const updateTimer = () => {
        const now = Date.now();
        const remaining = Math.max(0, roomData.expiresAt - now);
        const minutes = Math.floor(remaining / 60000);
        const seconds = Math.floor((remaining % 60000) / 1000);
        
        if (timeRemaining) {
          timeRemaining.textContent = `${minutes}:${seconds.toString().padStart(2, '0')} remaining`;
        }

        if (remaining === 0) {
          if (timerInterval) clearInterval(timerInterval);
          toast('Room has expired', 'warning');
          setTimeout(() => window.location.href = '/mood.html', 2000);
        }
      };

      timerInterval = setInterval(updateTimer, 1000);
      updateTimer();

      const idToken = await firebaseUser.getIdToken();
      const socketUrl = window.location.origin;
      const socketInstance = io(socketUrl, {
        transports: ['websocket', 'polling'],
        reconnection: true,
        reconnectionDelay: 500,
        reconnectionAttempts: 10,
        auth: { token: idToken }
      });

      socketInstance.on('connect', () => {
        console.log('ðŸ”Œ Socket connected:', socketInstance.id);
        socketInstance.emit('authenticate', {
          token: idToken,
          userId: currentUser.userId
        });
      });

      socketInstance.on('authenticated', (data) => {
        console.log('âœ… Socket authenticated:', data);
        socketInstance.emit('join_room', { roomId: roomData.roomId });
      });

      socketInstance.on('room_joined', (data) => {
        console.log('âœ… Room joined successfully:', data);
      });

      socketInstance.on('error', (data) => {
        console.error('âŒ Socket error:', data);
        if (data.code === 'ROOM_NOT_FOUND' || data.code === 'NOT_IN_ROOM') {
          toast('Room no longer available', 'error');
          setTimeout(() => window.location.href = '/mood.html', 2000);
        } else {
          toast(data.message || 'An error occurred', 'error');
        }
      });

      socketInstance.on('chat_message', (data) => {
        const isCurrentUser = data.userId === currentUser.userId;
        const msgEl = createMessageElement(data, isCurrentUser);
        if (messagesList) {
          messagesList.appendChild(msgEl);
          messagesList.scrollTop = messagesList.scrollHeight;
        }
      });

      socketInstance.on('user_left', (data) => {
        const msgEl = document.createElement('div');
        msgEl.className = 'text-center text-xs sm:text-sm text-gray-400 my-2';
        msgEl.textContent = `${data.username || 'A user'} left the room`;
        if (messagesList) messagesList.appendChild(msgEl);

        if (onlineCount && data.remainingUsers !== undefined) {
          onlineCount.textContent = `${data.remainingUsers} Online`;
        }

        if (data.remainingUsers <= 1) {
          toast('Room closing...', 'warning');
          setTimeout(() => window.location.href = '/mood.html', 2000);
        }
      });

      socketInstance.on('left_room', (data) => {
        toast('Left room', 'success');
        setTimeout(() => window.location.href = '/mood.html', 1000);
      });

      socketInstance.on('incoming_call', (data) => {
        pendingCallData = data;
        const callerName = document.getElementById('callerName');
        const callType = document.getElementById('callType');
        const callerAvatar = document.getElementById('callerAvatar');
        
        if (callerName) callerName.textContent = `${data.callerUsername} is calling`;
        if (callType) callType.textContent = data.callType === 'video' ? 'Video Call' : 'Audio Call';
        if (callerAvatar) {
          callerAvatar.innerHTML = '';
          const pfp = createProfilePictureElement(data.callerPfp, data.callerUsername, 'w-full h-full');
          callerAvatar.appendChild(pfp);
        }
        
        incomingCallModal.classList.remove('hidden');
      });

      socketInstance.on('call_accepted', (data) => {
        console.log('âœ… Call accepted:', data);
        isInitiatingCall = false;
        navigatingToCall = true;
        
        localStorage.setItem('activeCall', JSON.stringify({
          callId: data.callId,
          roomId: roomData.roomId,
          callType: data.callType,
          users: data.users
        }));
        
        console.log('ðŸš€ Navigating to call page');
        window.location.href = '/call.html';
      });

      socketInstance.on('call_declined', (data) => {
        toast('Call was declined', 'warning');
        isInitiatingCall = false;
        if (audioCallBtn) audioCallBtn.classList.remove('calling');
        if (videoCallBtn) videoCallBtn.classList.remove('calling');
      });

      if (audioCallBtn) {
        audioCallBtn.addEventListener('click', () => {
          if (isInitiatingCall) return;
          isInitiatingCall = true;
          audioCallBtn.classList.add('calling');
          videoCallBtn.classList.add('calling');
          
          socketInstance.emit('initiate_call', {
            roomId: roomData.roomId,
            callType: 'audio'
          });
          toast('Calling...', 'success');
          
          setTimeout(() => {
            if (isInitiatingCall) {
              isInitiatingCall = false;
              audioCallBtn.classList.remove('calling');
              videoCallBtn.classList.remove('calling');
            }
          }, 30000);
        });
      }

      if (videoCallBtn) {
        videoCallBtn.addEventListener('click', () => {
          if (isInitiatingCall) return;
          isInitiatingCall = true;
          audioCallBtn.classList.add('calling');
          videoCallBtn.classList.add('calling');
          
          socketInstance.emit('initiate_call', {
            roomId: roomData.roomId,
            callType: 'video'
          });
          toast('Calling...', 'success');
          
          setTimeout(() => {
            if (isInitiatingCall) {
              isInitiatingCall = false;
              audioCallBtn.classList.remove('calling');
              videoCallBtn.classList.remove('calling');
            }
          }, 30000);
        });
      }

      if (acceptCallBtn) {
        acceptCallBtn.addEventListener('click', () => {
          if (pendingCallData) {
            socketInstance.emit('accept_call', {
              callId: pendingCallData.callId,
              roomId: roomData.roomId
            });
            incomingCallModal.classList.add('hidden');
            pendingCallData = null;
          }
        });
      }

      if (declineCallBtn) {
        declineCallBtn.addEventListener('click', () => {
          if (pendingCallData) {
            socketInstance.emit('decline_call', {
              callId: pendingCallData.callId,
              roomId: roomData.roomId
            });
            incomingCallModal.classList.add('hidden');
            pendingCallData = null;
          }
        });
      }

      if (messageForm) {
        messageForm.addEventListener('submit', (e) => {
          e.preventDefault();
          const message = messageInput ? messageInput.value.trim() : '';
          if (!message) return;

          const messageData = {
            roomId: roomData.roomId,
            message: message
          };

          if (replyingTo) {
            messageData.replyTo = {
              messageId: replyingTo.messageId,
              username: replyingTo.username,
              message: replyingTo.message,
              userId: replyingTo.userId
            };
            hideReplyPreview();
          }

          socketInstance.emit('chat_message', messageData);
          if (messageInput) messageInput.value = '';
        });
      }

      if (leaveBtn) {
        leaveBtn.addEventListener('click', () => {
          socketInstance.emit('leave_room');
        });
      }

      window.addEventListener('beforeunload', (e) => {
        if (navigatingToCall) {
          console.log('ðŸ”’ Socket kept alive - navigating to call');
          return;
        }
        
        console.log('ðŸšª Normal page close - cleaning up');
        if (socketInstance) {
          socketInstance.emit('leave_room');
          socketInstance.disconnect();
        }
        if (timerInterval) {
          clearInterval(timerInterval);
        }
      });

    })();
    </script>
</body>
</html>
