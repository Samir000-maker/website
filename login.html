<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - MoodEmoji</title>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <link href="global.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
</head>
<body class="bg-background-light min-h-screen flex flex-col">
    <header class="w-full border-b border-border-light bg-surface-light/80 backdrop-blur-md sticky top-0 z-50">
        <div class="max-w-[1200px] mx-auto px-6 h-16 flex items-center justify-between">
            <a href="/" class="flex items-center gap-3 text-text-main-light transition-opacity hover:opacity-80">
                <span class="text-2xl">ðŸ˜Š</span>
                <h2 class="text-xl font-bold tracking-tight">MoodEmoji</h2>
            </a>
            <a href="/signup.html" class="text-sm font-semibold hover:text-primary transition-colors">Sign Up</a>
        </div>
    </header>

    <main class="flex-grow flex items-center justify-center p-6 relative overflow-hidden">
        <div class="absolute top-[-10%] left-[-5%] w-[500px] h-[500px] bg-primary/5 rounded-full blur-[100px] -z-10 pointer-events-none"></div>
        <div class="absolute bottom-[-10%] right-[-5%] w-[400px] h-[400px] bg-teal-200/20 rounded-full blur-[80px] -z-10 pointer-events-none"></div>
        
        <div class="w-full max-w-[440px]">
            <div class="bg-surface-light rounded-xl shadow-soft border border-border-light p-8 md:p-10 animate-fade-in-up">
                <div class="mb-8 text-center">
                    <div class="inline-flex items-center justify-center size-12 rounded-full bg-primary/10 text-primary mb-4">
                        <span class="material-symbols-outlined">lock_open</span>
                    </div>
                    <h1 class="text-2xl md:text-3xl font-bold text-text-main-light mb-2">Welcome Back</h1>
                    <p class="text-text-sub-light text-sm">Please enter your details to continue tracking</p>
                </div>

                <form id="loginForm" class="flex flex-col gap-5">
                    <div class="space-y-2">
                        <label for="email" class="text-sm font-semibold text-text-main-light block">Email Address</label>
                        <input type="email" id="email" required
                            class="form-input w-full h-12 px-4 rounded-lg border-border-light bg-background-light text-text-main-light focus:border-primary focus:ring-1 focus:ring-primary transition-all"
                            placeholder="name@example.com">
                    </div>

                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <label for="password" class="text-sm font-semibold text-text-main-light block">Password</label>
                            <a href="#" class="text-xs font-semibold text-primary hover:text-primary/80 transition-colors">Forgot Password?</a>
                        </div>
                        <input type="password" id="password" required
                            class="form-input w-full h-12 px-4 rounded-lg border-border-light bg-background-light text-text-main-light focus:border-primary focus:ring-1 focus:ring-primary transition-all"
                            placeholder="Enter your password">
                    </div>

                    <button type="submit" class="btn btn-primary w-full h-12 mt-2">
                        <span>Sign In</span>
                        <span class="material-symbols-outlined text-[18px] ml-2">arrow_forward</span>
                    </button>

                    <div class="relative flex py-2 items-center">
                        <div class="flex-grow border-t border-border-light"></div>
                        <span class="mx-4 text-xs font-medium text-text-sub-light">Or continue with</span>
                        <div class="flex-grow border-t border-border-light"></div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <button type="button" id="googleSignIn" class="h-10 flex items-center justify-center gap-2 rounded-lg border border-border-light bg-background-light hover:bg-gray-100 transition-colors">
                            <img alt="Google Logo" class="size-5" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%234285F4' d='M23.766 12.2764C23.766 11.4607 23.6999 10.6406 23.5588 9.83807H12.24V14.4591H18.7217C18.4528 15.9494 17.5885 17.2678 16.323 18.1056V21.1039H20.19C22.4608 19.0139 23.766 15.9274 23.766 12.2764Z'/%3E%3Cpath fill='%2334A853' d='M12.24 24.0008C15.4765 24.0008 18.2059 22.9382 20.1945 21.1039L16.3275 18.1055C15.2517 18.8375 13.8627 19.252 12.2445 19.252C9.11388 19.252 6.45946 17.1399 5.50705 14.3003H1.5166V17.3912C3.55371 21.4434 7.7029 24.0008 12.24 24.0008Z'/%3E%3Cpath fill='%23FBBC05' d='M5.50253 14.3003C5.00236 12.8099 5.00236 11.1961 5.50253 9.70575V6.61481H1.5166C-0.18551 10.0056 -0.18551 14.0004 1.5166 17.3912L5.50253 14.3003Z'/%3E%3Cpath fill='%23EA4335' d='M12.24 4.74966C13.9509 4.7232 15.6044 5.36697 16.8434 6.54867L20.2695 3.12262C18.1001 1.0855 15.2208 -0.034466 12.24 0.000808666C7.7029 0.000808666 3.55371 2.55822 1.5166 6.61481L5.50253 9.70575C6.45064 6.86173 9.10947 4.74966 12.24 4.74966Z'/%3E%3C/svg%3E">
                            <span class="text-sm font-semibold text-text-main-light">Google</span>
                        </button>
                        <button type="button" class="h-10 flex items-center justify-center gap-2 rounded-lg border border-border-light bg-background-light hover:bg-gray-100 transition-colors">
                            <span class="material-symbols-outlined text-text-main-light text-[22px]">ios</span>
                            <span class="text-sm font-semibold text-text-main-light">Apple</span>
                        </button>
                    </div>
                </form>

                <div class="mt-8 text-center">
                    <p class="text-sm text-text-sub-light">
                        Don't have an account?
                        <a href="/signup.html" class="font-bold text-primary hover:text-primary/80 transition-colors ml-1">Sign up</a>
                    </p>
                </div>
            </div>

            <div class="mt-6 flex justify-center gap-6 opacity-60 hover:opacity-100 transition-opacity">
                <a href="#" class="text-xs font-medium text-text-sub-light hover:text-primary">Privacy Policy</a>
                <a href="#" class="text-xs font-medium text-text-sub-light hover:text-primary">Terms of Service</a>
                <a href="#" class="text-xs font-medium text-text-sub-light hover:text-primary">Help Center</a>
            </div>
        </div>
    </main>

    <script src="app.js"></script>

<script>
  (function() {
      const MoodApp = window.MoodApp || {};
      const _Auth = MoodApp.Auth;
      const _Toast = MoodApp.Toast;
      const _Loading = MoodApp.Loading;
      const _PageTransition = MoodApp.PageTransition;
      const _Validator = MoodApp.Validator;

      const firebaseConfig = {
          apiKey: "AIzaSyA0aEEUk7uPGk2vK69HjhW7Ug0GCWOksLU",
          authDomain: "projectt3-8c55e.firebaseapp.com",
          projectId: "projectt3-8c55e",
          storageBucket: "projectt3-8c55e.firebasestorage.app",
          messagingSenderId: "64611387728",
          appId: "1:64611387728:web:2e53a18151ab3de1b60455",
          measurementId: "G-0Z91D0Q6EE"
      };

      try {
        if (window.firebase && !firebase.apps?.length) {
          firebase.initializeApp(firebaseConfig);
        }
      } catch (error) {
        console.error('Firebase init error:', error);
      }

      // Check if user is already logged in
      firebase.auth().onAuthStateChanged(async (user) => {
          if (user) {
              console.log('User already signed in, redirecting...');
              if (_PageTransition && typeof _PageTransition.navigateTo === 'function') {
                  _PageTransition.navigateTo('/mood.html');
              } else {
                  window.location.href = '/mood.html';
              }
          }
      });

      // Use API helper to get base URL
      const getApiBaseUrl = () => {
          if (_API && _API.BASE_URL) {
              return _API.BASE_URL;
          }
          try {
              const { hostname, port } = window.location;
              if ((hostname === '127.0.0.1' || hostname === 'localhost') && port === '5500') {
                  return 'http://localhost:3000';
              }
          } catch {}
          return window.location.origin;
      };

      const toastError = (msg) => {
        if (_Toast && typeof _Toast.error === 'function') return _Toast.error(msg);
        console.error('Toast.error:', msg);
      };
      const toastSuccess = (msg) => {
        if (_Toast && typeof _Toast.success === 'function') return _Toast.success(msg);
        console.log('Toast.success:', msg);
      };
      const loadingShow = (msg) => { if (_Loading && typeof _Loading.show === 'function') _Loading.show(msg); };
      const loadingHide = () => { if (_Loading && typeof _Loading.hide === 'function') _Loading.hide(); };

      const loginForm = document.getElementById('loginForm');
      const googleBtn = document.getElementById('googleSignIn');

      if (loginForm) {
        loginForm.addEventListener('submit', async (e) => {
          e.preventDefault();

          const email = document.getElementById('email')?.value.trim() || '';
          const password = document.getElementById('password')?.value || '';

          if (!_Validator || typeof _Validator.isValidEmail !== 'function') {
            if (!email) { toastError('Please enter a valid email address'); return; }
          } else {
            if (!_Validator.isValidEmail(email)) { toastError('Please enter a valid email address'); return; }
          }

          if (!password) { toastError('Please enter your password'); return; }

          loadingShow('Signing in...');

          try {
            const userCredential = await firebase.auth().signInWithEmailAndPassword(email, password);
            const idToken = await userCredential.user.getIdToken();

            if (_Auth && typeof _Auth.setAuth === 'function') {
              _Auth.setAuth(idToken, { email, uid: userCredential.user.uid });
            }

            loadingHide();
            toastSuccess('Welcome back!');

            if (_PageTransition && typeof _PageTransition.navigateTo === 'function') {
              _PageTransition.navigateTo('/mood.html');
            } else {
              window.location.href = '/mood.html';
            }
          } catch (error) {
            loadingHide();
            console.error('Login error:', error);
            toastError(error?.message || 'Failed to sign in');
          }
        });
      }

      if (googleBtn) {
        googleBtn.addEventListener('click', async () => {
          loadingShow('Signing in with Google...');

          try {
            const provider = new firebase.auth.GoogleAuthProvider();
            const result = await firebase.auth().signInWithPopup(provider);
            const idToken = await result.user.getIdToken();

            // Check if user profile exists in backend
            const apiBaseUrl = getApiBaseUrl();
            const checkResponse = await fetch(`${apiBaseUrl}/api/users/check-profile`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${idToken}`
                }
            });

            const checkData = await checkResponse.json();

            if (_Auth && typeof _Auth.setAuth === 'function') {
              _Auth.setAuth(idToken, {
                email: result.user.email,
                uid: result.user.uid,
                displayName: result.user.displayName,
                photoURL: result.user.photoURL
              });
            }

            loadingHide();

            // If user profile exists (existing user), go to mood.html
            if (checkData.exists && checkData.hasUsername) {
                toastSuccess('Welcome back!');
                setTimeout(() => {
                    if (_PageTransition && typeof _PageTransition.navigateTo === 'function') {
                        _PageTransition.navigateTo('/mood.html');
                    } else {
                        window.location.href = '/mood.html';
                    }}, 1000);
}
// New user - redirect to username page
else {
toastSuccess('Please complete your profile setup');
setTimeout(() => {
if (_PageTransition && typeof _PageTransition.navigateTo === 'function') {
_PageTransition.navigateTo('/username.html');
} else {
window.location.href = '/username.html';
}
}, 1000);
}
} catch (error) {
loadingHide();
console.error('Google sign in error:', error);
toastError(error?.message || 'Failed to sign in with Google');
}
});
}
})();
</script>
</body>
</html>
