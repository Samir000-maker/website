<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>How are you feeling? - MoodJournal</title>

  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200..800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --bg-dark: #16172b;
      --bg-card: #1e2139;
      --bg-card-hover: #252846;
      --border-dark: #2a2d4a;
      --text-primary: #ffffff;
      --text-secondary: #9ca3af;
      --text-muted: #6b7280;
      --accent-purple: #8b5cf6;
      --accent-purple-light: #a78bfa;
      --accent-blue: #6366f1;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Manrope', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg-dark);
      color: var(--text-primary);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .gradient-text {
      background: linear-gradient(135deg, #a78bfa 0%, #d946ef 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .header {
      border-bottom: 1px solid var(--border-dark);
      background: rgba(22, 23, 43, 0.8);
      backdrop-filter: blur(10px);
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      height: 64px;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .logo-icon {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .logo-text {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .nav {
      display: flex;
      gap: 32px;
      align-items: center;
    }

    .nav a {
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      transition: color 0.2s;
    }

    .nav a:hover {
      color: var(--text-primary);
    }

    .user-actions {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .notification-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: transparent;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      font-size: 20px;
      transition: all 0.2s;
    }

    .notification-btn:hover {
      background: var(--bg-card);
      color: var(--text-primary);
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #f59e0b 0%, #ea580c 100%);
      cursor: pointer;
      border: 2px solid transparent;
      transition: border-color 0.2s;
    }

    .user-avatar:hover {
      border-color: var(--accent-purple);
    }

    main {
      flex: 1;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 48px 24px;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(139, 92, 246, 0.15);
      color: var(--accent-purple-light);
      padding: 8px 16px;
      border-radius: 24px;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.5px;
      margin-bottom: 24px;
    }

    .status-indicator {
      width: 6px;
      height: 6px;
      background: var(--accent-purple-light);
      border-radius: 50%;
    }

    .hero {
      text-align: center;
      margin-bottom: 48px;
    }

    .hero h1 {
      font-size: 56px;
      font-weight: 800;
      line-height: 1.1;
      margin-bottom: 16px;
      letter-spacing: -0.02em;
    }

    .hero p {
      font-size: 16px;
      color: var(--text-secondary);
      max-width: 560px;
      margin: 0 auto 40px;
      line-height: 1.6;
    }

    .primary-btn {
      background: white;
      color: #16172b;
      border: none;
      padding: 16px 32px;
      border-radius: 48px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .primary-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
    }

    .primary-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .helper-text {
      text-align: center;
      color: var(--text-muted);
      font-size: 13px;
      margin-bottom: 32px;
      margin-top: 12px;
    }

    .moods-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 16px;
      max-width: 800px;
      margin: 0 auto 40px;
    }

    .mood-card {
      background: var(--bg-card);
      border: 2px solid var(--border-dark);
      border-radius: 16px;
      padding: 32px 24px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }

    .mood-card:hover {
      background: var(--bg-card-hover);
      border-color: #3d4062;
    }

    .mood-card.selected {
      background: rgba(99, 102, 241, 0.1);
      border-color: #6366f1;
      box-shadow: 0 0 0 1px #6366f1;
    }

    .mood-card.selected::after {
      content: '‚úì';
      position: absolute;
      top: 12px;
      right: 12px;
      width: 24px;
      height: 24px;
      background: #6366f1;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 700;
      color: white;
    }

    .mood-emoji {
      font-size: 56px;
      line-height: 1;
    }

    .mood-label {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      text-transform: capitalize;
    }

    .context-section {
      max-width: 700px;
      margin: 0 auto 48px;
      background: var(--bg-card);
      border: 1px solid var(--border-dark);
      border-radius: 16px;
      padding: 24px;
    }

    .context-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
    }

    .context-icon {
      font-size: 18px;
    }

    .context-label {
      font-size: 12px;
      font-weight: 700;
      color: var(--text-secondary);
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }

    .context-textarea {
      width: 100%;
      background: rgba(0, 0, 0, 0.2);
      border: 1px solid var(--border-dark);
      border-radius: 12px;
      padding: 16px;
      color: var(--text-primary);
      font-size: 14px;
      font-family: inherit;
      resize: none;
      outline: none;
      transition: all 0.2s;
      line-height: 1.6;
    }

    .context-textarea::placeholder {
      color: var(--text-muted);
    }

    .context-textarea:focus {
      border-color: var(--accent-blue);
      background: rgba(0, 0, 0, 0.3);
    }

    .context-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 12px;
      gap: 8px;
    }

    .privacy-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .secondary-btn {
      background: rgba(139, 92, 246, 0.15);
      color: var(--accent-purple-light);
      border: 1px solid rgba(139, 92, 246, 0.3);
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
    }

    .secondary-btn:hover:not(:disabled) {
      background: rgba(139, 92, 246, 0.25);
      border-color: rgba(139, 92, 246, 0.5);
    }

    .secondary-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .secondary-btn .material-symbols-outlined {
      font-size: 18px;
    }

    .sessions-section {
      margin-top: 64px;
    }

    .sessions-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
    }

    .sessions-title {
      font-size: 20px;
      font-weight: 700;
    }

    .view-all-link {
      color: var(--accent-purple-light);
      text-decoration: none;
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 4px;
      transition: color 0.2s;
    }

    .view-all-link:hover {
      color: var(--accent-purple);
    }

    .sessions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
    }

    .session-card {
      background: var(--bg-card);
      border: 1px solid var(--border-dark);
      border-radius: 12px;
      padding: 20px;
      transition: all 0.2s;
      cursor: pointer;
    }

    .session-card:hover {
      background: var(--bg-card-hover);
      border-color: #3d4062;
      transform: translateY(-2px);
    }

    .session-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .session-emoji {
      width: 40px;
      height: 40px;
      background: rgba(139, 92, 246, 0.15);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .session-info {
      flex: 1;
    }

    .session-mood {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .session-time {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .session-text {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    footer {
      border-top: 1px solid var(--border-dark);
      padding: 24px;
      margin-top: 64px;
    }

    .footer-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .footer-brand {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-muted);
      font-size: 13px;
    }

    .footer-links {
      display: flex;
      gap: 24px;
    }

    .footer-links a {
      color: var(--text-muted);
      text-decoration: none;
      font-size: 13px;
      transition: color 0.2s;
    }

    .footer-links a:hover {
      color: var(--text-primary);
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-fade-in-up {
      animation: fadeInUp 0.5s ease-out;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border-dark);
      border-top-color: var(--accent-purple);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .hidden {
      display: none !important;
    }

    @media (max-width: 768px) {
      .hero h1 {
        font-size: 40px;
      }

      .moods-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
      }

      .mood-card {
        padding: 24px 16px;
      }

      .mood-emoji {
        font-size: 40px;
      }

      .nav {
        display: none;
      }

      .sessions-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-content">
      <div class="logo">
        <div class="logo-icon">‚ú¶</div>
        <span class="logo-text">Vibegra</span>
      </div>
      <nav class="nav">
        <a href="#"></a>
        <a href="#"></a><!-- discover -->
        <a href="#"></a>
      </nav>
<div class="user-actions">
  <button class="notification-btn"></button>
  <span class="logout-text" id="logoutBtn">Logout</span>
</div>
      </div>
    </div>
  </header>

  <main>
    <div class="hero animate-fade-in-up">
      <div class="status-badge">
        <span class="status-indicator"></span>
        <!-- 4,281 USERS ONLINE -->
        <span>Welcome to Vibegra</span> 
      </div>
      <h1>
        Connect with your<br>
        <span class="gradient-text">Vibe</span>
      </h1>
      <p>
        Choose your current mood to chat with people who feel the same way
      </p>
      <button id="enterChatBtn" class="primary-btn" disabled>
        <span>Enter Chat Room</span>
        <span>‚Üí</span>
      </button>
      <div class="helper-text">Select a mood card below first</div>
    </div>

    <div id="moodsGrid" class="moods-grid animate-fade-in-up" style="animation-delay: 0.1s">
      <!-- Moods will be loaded here -->
    </div>

    <div class="context-section">
      <div class="context-header">
        <span class="context-icon">‚úçÔ∏è</span>
        <span class="context-label">Add Public NOTE (Optional)</span>
      </div>
      <textarea 
        id="noteText"
        class="context-textarea"
        rows="3"
        maxlength="500"
        placeholder="Briefly describe why you are feeling Calm... This helps match you with better conversations."></textarea>
      <div class="context-footer">
        <span class="privacy-badge">
          <span>üåê Global</span>
          <span></span>
        </span>
        <button id="logMoodBtn" disabled class="secondary-btn">
          <span class="material-symbols-outlined">edit</span>
          <span>Log Mood</span>
        </button>
      </div>
    </div>

    <div class="sessions-section">
      <div class="sessions-header">
  <h2 class="sessions-title">Public Notes</h2>
  <span class="view-all-link" style="cursor: default; opacity: 0.6;">
    <span>Scroll for more</span>
    <span>‚Üì</span>
  </span>
</div>

      <div id="notesList" class="sessions-grid">
        <!-- Sessions will be loaded here -->
      </div>

      <div id="loading" class="hidden" style="text-align: center; padding: 32px;">
        <div class="loading-spinner" style="margin: 0 auto;"></div>
      </div>
    </div>
  </main>

  <footer>
    <div class="footer-content">
      <div class="footer-brand">
        <span>‚ú¶</span>
        <span>¬© 2026 Vibegra</span>
      </div>
      <div class="footer-links">
        <a href="#">Privacy</a>
        <a href="#">Terms</a>
        <a href="#">Help</a>
      </div>
    </div>
  </footer>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

  <!-- Socket.IO Client -->
  <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>

  <!-- Initialize Firebase -->
  <script>

// At the start of your page script
if (window.StateManager) {
  const state = window.StateManager.getState();
  
  // If coming from expired room, clear state
  if (state.room && window.StateManager.isRoomExpired()) {
    window.StateManager.clearRoom();
  }
  
  // Set current page
  window.StateManager.setPage('mood');
}
    
    const firebaseConfig = {
      apiKey: "AIzaSyA0aEEUk7uPGk2vK69HjhW7Ug0GCWOksLU",
      authDomain: "projectt3-8c55e.firebaseapp.com",
      projectId: "projectt3-8c55e",
      storageBucket: "projectt3-8c55e.firebasestorage.app",
      messagingSenderId: "64611387728",
      appId: "1:64611387728:web:2e53a18151ab3de1b60455",
      measurementId: "G-0Z91D0Q6EE"
    };
    try {
      if (!firebase.apps?.length) {
        firebase.initializeApp(firebaseConfig);
      }
      // Critical: Set auth persistence
      firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL);
    } catch (err) {
      console.error('Firebase init error', err);
    }
  </script>

  <!-- Load app.js -->
  <script src="app.js"></script>

  <!-- Page-specific script -->
  <script>
  (async function () {
    const MoodApp = window.MoodApp || {};
    const _Auth = MoodApp.Auth;
    const _API = MoodApp.API;
    const _Toast = MoodApp.Toast;
    const _Loading = MoodApp.Loading;
    const _PageTransition = MoodApp.PageTransition;
    const _Utils = MoodApp.Utils;

    // Helper functions
    const toast = (m, t='success') => { 
      if (_Toast && typeof _Toast[t] === 'function') return _Toast[t](m); 
      console[t==='error'?'error':'log'](m); 
    };
    const showLoading = (m) => { 
      if (_Loading && typeof _Loading.show === 'function') _Loading.show(m); 
    };
    const hideLoading = () => { 
      if (_Loading && typeof _Loading.hide === 'function') _Loading.hide(); 
    };

    // DOM refs
    const moodsGrid = document.getElementById('moodsGrid');
    const noteText = document.getElementById('noteText');
    const logMoodBtn = document.getElementById('logMoodBtn');
    const enterChatBtn = document.getElementById('enterChatBtn');
    const notesList = document.getElementById('notesList');
    const loadingEl = document.getElementById('loading');
    const loadMoreBtn = document.getElementById('loadMoreBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    const moods = {
      happy: 'üòä', sad: 'üò≠', angry: 'üò†', lonely: 'üòî',
      calm: 'üòå', excited: 'ü§©', tired: 'üò¥', stressed: 'üò£', confused: 'üòï'
    };

    let selectedMood = null;
    let page = 0;
    let socketInstance = null;
    let currentUser = null;

    // ============================================
    // SOCKET.IO CONNECTION
    // ============================================
    
(function() {
  'use strict';
  
  console.log('====================================');
  console.log('üîí BACK BUTTON BLOCKER LOADING...');
  console.log('====================================');
  
  let initialized = false;
  let popstateAttached = false;
  
  // Main initialization function
  function initBackButtonBlocker() {
    
    if (initialized) {
      console.warn('‚ö†Ô∏è  Back button blocker already initialized, skipping...');
      return;
    }
    
    console.log('üìç Step 1: Pushing initial history state...');
    
    // Push a state to create history entry
    history.pushState(null, '', location.href);
    
    console.log('‚úÖ Step 1 Complete: History state pushed');
    console.log('   Current URL:', location.href);
    console.log('   History length:', history.length);
    
    // Attach popstate listener
    console.log('üìç Step 2: Attaching popstate event listener...');
    
    window.addEventListener('popstate', function(event) {
      
      console.log('');
      console.log('üö®üö®üö® BACK BUTTON PRESSED! üö®üö®üö®');
      console.log('Event state:', event.state);
      console.log('Current URL:', location.href);
      console.log('Action: Pushing forward to block navigation...');
      
      // Immediately push forward to cancel back navigation
      history.pushState(null, '', location.href);
      
      console.log('‚úÖ Navigation blocked - staying on current page');
      console.log('   New history length:', history.length);
      console.log('');
      
      // Optional: Show toast to user
      if (window.MoodApp && window.MoodApp.Toast && typeof window.MoodApp.Toast.warning === 'function') {
        window.MoodApp.Toast.warning('Please use logout to exit');
      }
      
    });
    
    popstateAttached = true;
    console.log('‚úÖ Step 2 Complete: Event listener attached');
    
    initialized = true;
    
    console.log('');
    console.log('====================================');
    console.log('‚úÖ BACK BUTTON BLOCKER ACTIVE');
    console.log('====================================');
    console.log('Try pressing the back button now...');
    console.log('');
  }
  
  // Auto-run on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initBackButtonBlocker);
  } else {
    initBackButtonBlocker();
    alternativeBackButtonBlocker();
  }
  
  // Expose for manual testing
  window.testBackButtonBlocker = function() {
    console.log('');
    console.log('=== MANUAL TEST ===');
    console.log('Simulating back button press...');
    history.back();
    setTimeout(() => {
      console.log('Test complete. Check if page navigated or stayed.');
      console.log('Current URL:', location.href);
    }, 100);
  };
  
  console.log('üí° TIP: You can test manually by typing: testBackButtonBlocker()');
  
})();
    
    
    function alternativeBackButtonBlocker() {
  console.log('üîÑ Using alternative method: history.go(1)');
  
  history.pushState(null, document.title, location.href);
  
  window.addEventListener('popstate', function(event) {
    console.log('üö® BACK PRESSED - Using history.go(1) to block');
    history.go(1);
  });
  
  console.log('‚úÖ Alternative blocker active');
}
    
function waitForTabManager() {
  return new Promise((resolve, reject) => {
    // Check if already available
    if (window.tabManager && window.tabManager.tabId) {
      console.log('‚úÖ [Auth] TabManager already ready:', window.tabManager.tabId);
      resolve(window.tabManager);
      return;
    }
    
    console.log('‚è≥ [Auth] Waiting for TabManager to initialize...');
    
    // Poll for TabManager (handles race conditions)
    let attempts = 0;
    const maxAttempts = 100; // 10 seconds max wait
    
    const interval = setInterval(() => {
      attempts++;
      
      if (window.tabManager && window.tabManager.tabId) {
        clearInterval(interval);
        console.log('‚úÖ [Auth] TabManager ready after waiting:', window.tabManager.tabId);
        resolve(window.tabManager);
      } else if (attempts >= maxAttempts) {
        clearInterval(interval);
        console.error('‚ùå [Auth] TabManager timeout after 10s');
        reject(new Error('TabManager initialization timeout'));
      }
    }, 100); // Check every 100ms
  });
}

/**
 * Authenticate socket with tab management
 * Call this INSTEAD of manually emitting 'authenticate'
 * 
 * @param {Socket} socket - Socket.IO instance
 * @param {string} userId - User's database ID
 * @returns {Promise} - Resolves when authenticated
 */
async function authenticateSocketWithTabManagement(socket, userId) {
  try {
    console.log('üîê [Auth] Starting socket authentication...');
    
    // 1. Wait for TabManager to be ready
    const tabManager = await waitForTabManager();
    const tabId = tabManager.tabId;
    
    console.log('‚úÖ [Auth] TabId retrieved:', tabId);
    
    // 2. Get Firebase token
    const firebaseUser = firebase.auth().currentUser;
    if (!firebaseUser) {
      throw new Error('Not authenticated with Firebase');
    }
    
    const token = await firebaseUser.getIdToken();
    console.log('‚úÖ [Auth] Firebase token retrieved');
    
    // 3. Send authentication event
    console.log('üì§ [Auth] Sending authenticate event:', {
      userId,
      tabId,
      socketId: socket.id
    });
    
    socket.emit('authenticate', {
      token: token,
      userId: userId,
      tabId: tabId  // ‚Üê CRITICAL: Include tabId
    });
    
    // 4. Wait for authentication response
    return new Promise((resolve, reject) => {
      const timeout = setTimeout(() => {
        reject(new Error('Authentication timeout (10s)'));
      }, 10000);
      
      // Success handler
      socket.once('authenticated', (data) => {
        clearTimeout(timeout);
        console.log('‚úÖ [Auth] Socket authenticated successfully:', data);
        resolve(data);
      });
      
      // Error handler
      socket.once('auth_error', (error) => {
        clearTimeout(timeout);
        console.error('‚ùå [Auth] Authentication failed:', error);
        
        // Handle specific error codes
        if (error.code === 'DUPLICATE_TAB') {
          console.warn('‚ö†Ô∏è [Auth] Another tab is active');
          // The TabManager will handle showing the overlay
        }
        
        reject(new Error(error.message || 'Authentication failed'));
      });
    });
    
  } catch (error) {
    console.error('‚ùå [Auth] Socket authentication error:', error);
    throw error;
  }
}

/**
 * Setup session replacement handler
 * Call this ONCE after socket connection
 * 
 * @param {Socket} socket - Socket.IO instance
 */
function setupSessionReplacementHandler(socket) {
  socket.on('session_replaced', (data) => {
    console.log('‚ö†Ô∏è [Session] This tab has been replaced by another:', data);
    
    // The TabManager will automatically show the "Use Here" overlay
    // No need for additional UI here
    
    // Optionally: Clean up page-specific state
    // e.g., stop timers, clear intervals, etc.
  });
  
  console.log('‚úÖ [Session] Replacement handler registered');
}

console.log('‚úÖ Socket authentication helpers loaded');
    
    
    
    async function initializeSocket() {
      try {
        // Get current Firebase user
        const firebaseUser = firebase.auth().currentUser;
        if (!firebaseUser) {
          console.error('No Firebase user found');
          return null;
        }

        // Get fresh ID token
        const idToken = await firebaseUser.getIdToken();

        // Get user profile from API
        if (!_API || typeof _API.get !== 'function') {
          console.error('API helper not available');
          return null;
        }

        const userData = await _API.get('/api/users/me');
        currentUser = {
          userId: userData._id,
          username: userData.username,
          pfpUrl: userData.pfpUrl,
          email: userData.email
        };

        console.log('‚úÖ Current user loaded:', currentUser);

        // Connect Socket.IO to backend server
        // Always connect to localhost:3000 regardless of where frontend is served
        const socketUrl = 'https://website-hdem.onrender.com';
        socketInstance = io(socketUrl, {
          transports: ['websocket', 'polling'],
          reconnection: true,
          reconnectionAttempts: 5,
          reconnectionDelay: 1000,
          auth: {
            token: idToken
          }
        });

socket.on('connect', async () => {
  console.log('üîå Socket connected:', socket.id);
  
  try {
    // ‚úÖ Authenticate with tab management (now waits for TabManager)
    await authenticateSocketWithTabManagement(socket, currentUser.userId);
    
    // ‚úÖ Setup session replacement handler
    setupSessionReplacementHandler(socket);
    
    console.log('‚úÖ Socket authenticated and ready');
    
  } catch (error) {
    console.error('‚ùå Authentication failed:', error);
    // Handle error appropriately
    MoodApp.Toast.error('Connection failed. Please refresh the page.');
  }
});


        socketInstance.on('authenticated', (data) => {
          console.log('‚úÖ Socket authenticated:', data);
        });

        socketInstance.on('auth_error', (data) => {
          console.error('‚ùå Socket auth error:', data);
          toast('Authentication failed. Please refresh the page.', 'error');
        });

        socketInstance.on('connect_error', (error) => {
          console.error('üîå Socket connection error:', error);
        });

        socketInstance.on('disconnect', (reason) => {
          console.log('üîå Socket disconnected:', reason);
        });

        return socketInstance;
      } catch (error) {
        console.error('Socket initialization error:', error);
        return null;
      }
    }

    // ============================================
    // MOOD SELECTION
    // ============================================
    function renderMoods() {
      if (!moodsGrid) return;
      moodsGrid.innerHTML = '';
      Object.entries(moods).forEach(([id, emoji]) => {
        const card = document.createElement('div');
        card.className = 'mood-card';
        card.innerHTML = `
          <div class="mood-emoji">${emoji}</div>
          <div class="mood-label">${id}</div>
        `;
        card.addEventListener('click', () => selectMood(id, card));
        moodsGrid.appendChild(card);
      });
    }

    function selectMood(mood, el) {
      selectedMood = mood;
      document.querySelectorAll('.mood-card').forEach(b => {
        b.classList.remove('selected');
      });
      if (el) {
        el.classList.add('selected');
      }
      if (enterChatBtn) enterChatBtn.disabled = false;
      if (logMoodBtn) logMoodBtn.disabled = false;
    }

    // ============================================
    // ENTER CHAT (MATCHMAKING)
    // ============================================
    async function handleEnterChat() {
      if (!selectedMood) {
        toast('Please select a mood first', 'warning');
        return;
      }

      if (!socketInstance || !socketInstance.connected) {
        toast('Connecting to server...', 'warning');
        socketInstance = await initializeSocket();
        
        // Wait for connection
        await new Promise((resolve) => {
          if (socketInstance && socketInstance.connected) {
            resolve();
          } else if (socketInstance) {
            socketInstance.once('connect', resolve);
            setTimeout(() => resolve(), 5000); // Timeout after 5 seconds
          } else {
            resolve();
          }
        });

        if (!socketInstance || !socketInstance.connected) {
          toast('Failed to connect to server. Please try again.', 'error');
          return;
        }
      }

      // Store selected mood
      try {
        localStorage.setItem('selectedMood', selectedMood);
      } catch (e) {
        console.warn('LocalStorage not available:', e);
      }

      console.log('üéÆ Joining matchmaking with mood:', selectedMood);

      // Navigate to discovery page
      if (_PageTransition && typeof _PageTransition.navigateTo === 'function') {
        _PageTransition.navigateTo('/discovery.html');
      } else {
        window.location.href = '/discovery.html';
      }
    }

    // ============================================
    // LOG MOOD (NOTES)
    // ============================================
async function handleLogMood() {
  const text = (noteText && noteText.value) ? noteText.value.trim() : '';
  if (!text) {
    toast('Please add a note', 'warning');
    return;
  }
  if (!selectedMood) {
    toast('Please select a mood', 'warning');
    return;
  }

  showLoading('Saving your mood...');
  try {
    if (!_API || typeof _API.post !== 'function') throw new Error('API helper missing');
    
    console.log(`üíæ Logging mood: ${selectedMood} - "${text.substring(0, 50)}..."`);
    
    await _API.post('/api/notes', { text, mood: selectedMood });
    
    hideLoading();
    toast('Mood logged!', 'success');
    
    if (noteText) noteText.value = '';
    
    // CRITICAL: Reset pagination and reload from start
    console.log(`üîÑ Refreshing notes list after new entry`);
    currentNotePage = 0;
    hasMoreNotes = true;
    loadNotes(0, false); // Fresh load, not append
    
  } catch (err) {
    hideLoading();
    console.error('‚ùå Failed to log mood:', err);
    toast(err.message || 'Failed to log mood', 'error');
  }
}

    // ============================================
    // NOTES DISPLAY
    // ============================================
function renderNote(note) {
  console.log(`üìù Rendering note:`, {
    id: note._id,
    username: note.username,
    hasPfp: !!note.pfpUrl,
    mood: note.mood
  });

  const card = document.createElement('div');
  card.className = 'session-card';
  
  // CRITICAL FIX: Prioritize profile picture, fallback to mood emoji
  const moodEmoji = note?.mood ? (moods[note.mood] || 'üòä') : 'üòä';
  const hasPfp = note?.pfpUrl && note.pfpUrl !== null;
  
  // CRITICAL FIX: Use actual username from database
  const username = note?.username || 'Anonymous';
  
  const createdAt = note?.createdAt ? 
    (_Utils && typeof _Utils.formatDate === 'function' ? 
      _Utils.formatDate(note.createdAt) : 
      new Date(note.createdAt).toLocaleString()) : '';
      
  const moodLabel = note?.mood ? 
    note.mood.charAt(0).toUpperCase() + note.mood.slice(1) : 
    'Unknown';
    
  const textHtml = note?.text ? 
    (_Utils && typeof _Utils.escapeHtml === 'function' ? 
      _Utils.escapeHtml(note.text) : 
      (()=>{const d=document.createElement('div');d.textContent=note.text;return d.innerHTML;})()) : '';
  
  // CRITICAL FIX: Conditional rendering - profile picture OR mood emoji
  const avatarHtml = hasPfp 
    ? `<img src="${note.pfpUrl}" alt="${username}" class="session-emoji" style="border-radius: 50%; object-fit: cover; width: 40px; height: 40px;">` 
    : `<div class="session-emoji">${moodEmoji}</div>`;
  
  console.log(`‚úÖ Using ${hasPfp ? 'profile picture' : 'mood emoji fallback'} for ${username}`);
  
  card.innerHTML = `
    <div class="session-header">
      ${avatarHtml}
      <div class="session-info">
        <div class="session-mood">${username} ¬∑ ${moodLabel}</div>
        <div class="session-time">${createdAt}</div>
      </div>
    </div>
    <div class="session-text">${textHtml}</div>
  `;
  
  return card;
}

let isLoadingNotes = false;
let hasMoreNotes = true;
let currentNotePage = 0;

async function loadNotes(pageNum = 0, append = false) {
  if (isLoadingNotes) {
    console.log(`‚è≥ Already loading notes, skipping duplicate request`);
    return;
  }
  
  if (!hasMoreNotes && append) {
    console.log(`‚úã No more notes to load`);
    return;
  }

  isLoadingNotes = true;
  console.log(`üì• Loading notes: page=${pageNum}, append=${append}`);
  
  if (loadingEl) loadingEl.classList.remove('hidden');
  
  try {
    if (!_API || typeof _API.get !== 'function') {
      throw new Error('API.get missing');
    }
    
    const data = await _API.get(`/api/notes?page=${pageNum}&limit=10`);
    
    console.log(`‚úÖ Received ${data.notes?.length || 0} notes from server`);
    console.log(`   Total in database: ${data.total}`);
    console.log(`   Has more: ${data.hasMore}`);
    
    // Clear or append based on mode
    if (!append && notesList) {
      notesList.innerHTML = '';
      console.log(`üóëÔ∏è Cleared notes list (fresh load)`);
    }
    
    const notesArray = Array.isArray(data.notes) ? data.notes : [];
    
    if (notesArray.length === 0) {
      console.log(`‚ÑπÔ∏è No notes returned for page ${pageNum}`);
      if (!append && notesList) {
        notesList.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);">No mood entries yet. Log your first mood above!</div>';
      }
    } else {
      notesArray.forEach((n, idx) => { 
        console.log(`  [${idx}] ${n.username}: ${n.mood}`);
        if (notesList) notesList.appendChild(renderNote(n)); 
      });
      console.log(`‚úÖ Rendered ${notesArray.length} note cards`);
    }
    
    currentNotePage = pageNum;
    hasMoreNotes = data.hasMore;
    
    console.log(`üìä Pagination state: page=${currentNotePage}, hasMore=${hasMoreNotes}`);
    
  } catch (err) {
    console.error('‚ùå Failed to load notes:', err);
    toast(err.message || 'Failed to load notes', 'error');
  } finally {
    if (loadingEl) loadingEl.classList.add('hidden');
    isLoadingNotes = false;
    console.log(`üîì Released loading lock`);
  }
}

// CRITICAL: Implement scroll-based lazy loading
function initInfiniteScroll() {
  const scrollContainer = window;
  let scrollTimeout;

  scrollContainer.addEventListener('scroll', () => {
    // Debounce scroll events
    clearTimeout(scrollTimeout);
    scrollTimeout = setTimeout(() => {
      const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
      const windowHeight = window.innerHeight;
      const documentHeight = document.documentElement.scrollHeight;
      
      // Trigger when 200px from bottom
      const threshold = 200;
      const distanceFromBottom = documentHeight - (scrollTop + windowHeight);
      
      if (distanceFromBottom < threshold && hasMoreNotes && !isLoadingNotes) {
        console.log(`üìú Scroll threshold reached (${distanceFromBottom.toFixed(0)}px from bottom)`);
        console.log(`   Loading next page: ${currentNotePage + 1}`);
        loadNotes(currentNotePage + 1, true); // Append mode
      }
    }, 100); // 100ms debounce
  });

  console.log(`‚úÖ Infinite scroll initialized (threshold: 200px from bottom)`);
}

    // ============================================
    // LOGOUT
    // ============================================
    function handleLogout() {
      try {
        // Disconnect socket
        if (socketInstance) {
          socketInstance.disconnect();
          socketInstance = null;
        }

        // Clear auth
        if (_Auth && typeof _Auth.clearAuth === 'function') {
          _Auth.clearAuth();
        } else {
          localStorage.removeItem('user');
        }

        // Sign out from Firebase
        firebase.auth().signOut();
      } catch (e) {
        console.error('Logout error', e);
      }
      
      if (_PageTransition && typeof _PageTransition.navigateTo === 'function') {
        _PageTransition.navigateTo('/login.html');
      } else {
        window.location.href = '/login.html';
      }
    }

    // ============================================
    // EVENT LISTENERS
    // ============================================
function attachListeners() {
  if (logMoodBtn) logMoodBtn.addEventListener('click', handleLogMood);
  if (enterChatBtn) enterChatBtn.addEventListener('click', handleEnterChat);
  
  // REMOVED: Manual "View History" button - now auto-loads on scroll
  // if (loadMoreBtn) loadMoreBtn.addEventListener('click', () => loadNotes(page + 1));
  
  if (logoutBtn) logoutBtn.addEventListener('click', handleLogout);
  if (noteText) {
    noteText.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
        if (!logMoodBtn.disabled) handleLogMood();
      }
    });
  }
  
  // CRITICAL: Initialize infinite scroll
  initInfiniteScroll();
  console.log(`‚úÖ Event listeners attached`);
}

    // ============================================
    // INITIALIZATION
    // ============================================
async function initPage() {
  // Require authentication
  try {
    if (_Auth && typeof _Auth.requireAuth === 'function') {
      await _Auth.requireAuth();
    }
  } catch (err) {
    console.error('Error running requireAuth():', err);
    return;
  }

  // Prevent back navigation
  initBackButtonBlocker();  // ‚Üê ADD THIS LINE

  // Initialize Socket.IO
  console.log('üîå Initializing socket connection...');
  socketInstance = await initializeSocket();

  // Render UI
  renderMoods();
  attachListeners();
  loadNotes(0);
}

    // Start the page
    initPage();
  })();
  </script>
</body>
</html>
